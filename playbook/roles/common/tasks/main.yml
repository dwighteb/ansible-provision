---
- include_vars: vault.yml
  no_log: true

- name: ensure packages are installed
  apt:
    name: "{{ item }}"
    state: installed
    update_cache: yes
  with_items:
    - acpid
    - git
    - libpam-google-authenticator
    - ntp
    - sysstat
    - zsh

- name: ensure packages are not installed
  apt:
    name: fail2ban
    state: absent

- name: configure sudo
  copy:
    content: "{{ sudoers_90_admin }}"
    dest: /etc/sudoers.d/90-admin
    owner: root
    group: root
    mode: 0440

- name: enable sysstat
  lineinfile:
    dest: /etc/default/sysstat
    regexp: ^ENABLED
    line: ENABLED=true
  notify:
    - restart sysstat

- name: add my user ubuntu
  user:
    name: ubuntu
    shell: /bin/zsh
    comment: ubuntu user
    password: "{{ ubuntu_password }}"
    groups: adm,sudo
    append: yes

- name: authorized key file for ubuntu
  authorized_key:
    user: ubuntu
    key: https://github.com/dwighteb.keys

- name: ubuntu google authenticator file
  copy:
    content: "{{ ubuntu_google_authenticator }}"
    dest: /home/ubuntu/.google_authenticator
    owner: ubuntu
    group: ubuntu
    mode: 0400

- name: ubuntu download oh-my-zsh
  command: git clone git://github.com/robbyrussell/oh-my-zsh.git /home/ubuntu/.oh-my-zsh
  args:
      creates: /home/ubuntu/.oh-my-zsh
  become: true
  become_user: ubuntu

- name: ubuntu zshrc file
  copy:
    src: zshrc
    dest: /home/ubuntu/.zshrc
    owner: ubuntu
    group: ubuntu
    mode: 0644

- name: configure pam.d sshd for google authenticator
  lineinfile:
    dest: /etc/pam.d/sshd
    line: 'auth required pam_google_authenticator.so'
  notify:
    - restart ssh

- name: configure sshd
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  notify:
    - restart ssh
  with_items:
    - { regexp: '^ChallengeResponseAuthentication', line: 'ChallengeResponseAuthentication yes' }
    - { regexp: '^PasswordAuthentication',          line: 'PasswordAuthentication yes' }
    - { regexp: '^PermitRootLogin',                 line: 'PermitRootLogin no' }
    - { regexp: '^UseDNS',                          line: 'UseDNS no' }
